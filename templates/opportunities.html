{% extends "base.html" %}

{% block content %}
<style>
    /* ─── LOCAL VARIABLES ────────────────────────────────────── */
    :root {
        --green:        #2d8a6a;
        --green-bg:     rgba(45,138,106,.07);
        --green-border: rgba(45,138,106,.2);
        --amber:        #c47c1a;
        --amber-bg:     rgba(196,124,26,.07);
        --amber-border: rgba(196,124,26,.2);
        --red:          #c0392b;
        --red-bg:       rgba(192,57,43,.07);
        --red-border:   rgba(192,57,43,.2);
    }

    /* ─── PAGE LAYOUT ────────────────────────────────────────── */
    .opp-page {
        max-width: 1280px;
        margin: 0 auto;
        padding: 60px 48px 100px;
        position: relative;
    }

    /* Ambient background */
    .opp-page::before {
        content: '';
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background:
            radial-gradient(ellipse 60% 40% at 10% 10%, rgba(200,169,110,.04), transparent),
            radial-gradient(ellipse 50% 50% at 90% 80%, rgba(15,76,92,.05), transparent);
        pointer-events: none;
        z-index: 0;
    }

    /* ─── TOP BAR ────────────────────────────────────────────── */
    .opp-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 52px;
        animation: fadeUp .5s var(--ease) .1s both;
        position: relative; z-index: 1;
    }

    .breadcrumb {
        display: flex; align-items: center; gap: 10px;
        font-family: var(--font-mono); font-size: 10px;
        letter-spacing: .12em; text-transform: uppercase; color: var(--muted);
    }
    .breadcrumb a { color: var(--muted); text-decoration: none; transition: color .2s; }
    .breadcrumb a:hover { color: var(--ink); }
    .breadcrumb .sep { color: rgba(107,107,107,.3); }
    .breadcrumb strong { color: var(--ink); }

    /* Step indicator */
    .step-track {
        display: flex; align-items: center; gap: 0;
    }
    .step-node {
        display: flex; align-items: center; gap: 8px;
        font-family: var(--font-mono); font-size: 9px;
        letter-spacing: .1em; text-transform: uppercase; color: var(--muted);
    }
    .step-dot {
        width: 24px; height: 24px; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-family: var(--font-mono); font-size: 8px; font-weight: 500;
        flex-shrink: 0;
    }
    .step-dot.done  { background: #4caf92; color: var(--white); }
    .step-dot.active { background: var(--gold); color: var(--ink); box-shadow: 0 0 0 4px rgba(200,169,110,.25); }
    .step-connector { width: 40px; height: 1px; background: rgba(200,169,110,.25); margin: 0 8px; }

    /* ─── VERDICT BANNER ─────────────────────────────────────── */
    .verdict {
        border-radius: 3px; padding: 40px 48px;
        display: grid; grid-template-columns: 1fr auto;
        gap: 32px; align-items: center;
        margin-bottom: 52px; position: relative; overflow: hidden;
        animation: fadeUp .6s var(--ease) .2s both;
        z-index: 1;
    }
    .verdict::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0;
        height: 3px; background: linear-gradient(90deg, var(--gold), var(--teal));
    }
    .verdict.green  { background: var(--green-bg);  border: 1px solid var(--green-border); }
    .verdict.orange { background: var(--amber-bg);  border: 1px solid var(--amber-border); }
    .verdict.red    { background: var(--red-bg);    border: 1px solid var(--red-border); }
    .verdict.gold   { background: rgba(200,169,110,.06); border: 1px solid rgba(200,169,110,.22); }

    .verdict-label {
        font-family: var(--font-mono); font-size: 9px;
        letter-spacing: .18em; text-transform: uppercase;
        color: var(--muted); margin-bottom: 10px;
    }
    .verdict-title {
        font-family: var(--font-display); font-size: 36px; font-weight: 400;
        color: var(--ink); line-height: 1.15; margin-bottom: 12px;
    }
    .verdict-text {
        font-family: var(--font-ui); font-size: 14px; line-height: 1.75; color: var(--muted);
        max-width: 640px;
    }

    .verdict-score-box {
        background: var(--ink); border-radius: 3px;
        padding: 28px 36px; text-align: center; flex-shrink: 0;
    }
    .verdict-score-label {
        font-family: var(--font-mono); font-size: 8px;
        letter-spacing: .18em; text-transform: uppercase;
        color: rgba(253,252,250,.3); margin-bottom: 8px;
    }
    .verdict-score-num {
        font-family: var(--font-display); font-size: 64px;
        font-weight: 300; color: var(--white); line-height: 1;
    }
    .verdict-score-denom {
        font-family: var(--font-mono); font-size: 12px;
        color: rgba(253,252,250,.25); margin-top: 4px;
    }
    .verdict-score-gauge {
        height: 4px; background: rgba(255,255,255,.08);
        border-radius: 2px; overflow: hidden; margin-top: 12px;
    }
    .verdict-score-gauge-fill {
        height: 100%; border-radius: 2px;
        background: linear-gradient(90deg, var(--gold), var(--teal-light));
        transition: width 1.4s var(--ease);
    }

    /* ─── SECTION HEADER ─────────────────────────────────────── */
    .section-head {
        display: flex; align-items: baseline;
        justify-content: space-between;
        margin-bottom: 24px;
        position: relative; z-index: 1;
    }
    .section-head-title {
        font-family: var(--font-display); font-size: 28px;
        font-weight: 300; color: var(--ink);
    }
    .section-head-meta {
        font-family: var(--font-mono); font-size: 9px;
        letter-spacing: .14em; text-transform: uppercase; color: var(--muted);
    }

    /* ─── OPPORTUNITIES GRID ─────────────────────────────────── */
    .opp-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 48px;
        position: relative; z-index: 1;
    }

    /* ─── OPPORTUNITY CARD ───────────────────────────────────── */
    .opp-card {
        background: var(--white);
        border: 1.5px solid rgba(200,169,110,.18);
        border-radius: 3px;
        padding: 36px 32px;
        position: relative; overflow: hidden;
        transition: transform .35s var(--ease), box-shadow .35s var(--ease), border-color .25s;
        animation: fadeUp .6s var(--ease) both;
        cursor: default;
    }
    .opp-card:nth-child(1) { animation-delay: .25s; }
    .opp-card:nth-child(2) { animation-delay: .32s; }
    .opp-card:nth-child(3) { animation-delay: .39s; }
    .opp-card:nth-child(4) { animation-delay: .46s; }
    .opp-card:nth-child(5) { animation-delay: .53s; }
    .opp-card:nth-child(6) { animation-delay: .60s; }

    /* Top accent */
    .opp-card::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0;
        height: 3px; transform: scaleX(0); transform-origin: left;
        background: linear-gradient(90deg, var(--gold), var(--teal));
        transition: transform .4s var(--ease);
    }

    .opp-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 20px 56px rgba(10,11,13,.09);
        border-color: rgba(200,169,110,.38);
    }
    .opp-card:hover::before { transform: scaleX(1); }

    /* DISABLED state */
    .opp-card.disabled {
        opacity: .5; pointer-events: none;
        filter: grayscale(.6);
    }

    /* Icon */
    .opp-icon {
        width: 56px; height: 56px; border-radius: 2px;
        display: flex; align-items: center; justify-content: center;
        margin-bottom: 24px; position: relative;
    }
    .opp-icon svg { width: 28px; height: 28px; }

    .opp-icon.house       { background: rgba(15,76,92,.08);  color: var(--teal); }
    .opp-icon.car         { background: rgba(200,169,110,.12); color: var(--gold); }
    .opp-icon.land        { background: rgba(45,138,106,.08); color: var(--green); }
    .opp-icon.invest      { background: rgba(10,11,13,.06);  color: var(--ink); }
    .opp-icon.micro       { background: rgba(200,169,110,.1); color: var(--gold); }
    .opp-icon.business    { background: rgba(15,76,92,.1);   color: var(--teal); }

    .opp-category {
        font-family: var(--font-mono); font-size: 8px; font-weight: 500;
        letter-spacing: .18em; text-transform: uppercase; color: var(--muted);
        margin-bottom: 10px;
    }
    .opp-name {
        font-family: var(--font-display); font-size: 26px; font-weight: 400;
        color: var(--ink); line-height: 1.15; margin-bottom: 12px;
    }
    .opp-desc {
        font-family: var(--font-ui); font-size: 13px; line-height: 1.7;
        color: var(--muted); margin-bottom: 24px;
    }

    .opp-divider {
        height: 1px; background: rgba(200,169,110,.12); margin-bottom: 20px;
    }

    /* Montant estimé */
    .opp-amount-row {
        display: flex; align-items: baseline; gap: 6px; margin-bottom: 16px;
    }
    .opp-amount {
        font-family: var(--font-display); font-size: 32px; font-weight: 300; color: var(--ink);
    }
    .opp-amount-unit {
        font-family: var(--font-mono); font-size: 10px; color: var(--muted);
        letter-spacing: .08em;
    }

    /* Conditions */
    .opp-conditions {
        display: flex; flex-direction: column; gap: 8px;
    }
    .opp-condition {
        display: flex; align-items: center; gap: 10px;
        font-family: var(--font-mono); font-size: 10px;
        letter-spacing: .05em; color: var(--muted);
    }
    .opp-condition-dot {
        width: 5px; height: 5px; border-radius: 50%;
        background: var(--gold); flex-shrink: 0;
    }
    .opp-condition-dot.green { background: #4caf92; }
    .opp-condition-dot.red   { background: #e05c5c; }

    /* Eligibility badge */
    .opp-badge {
        position: absolute; top: 20px; right: 20px;
        font-family: var(--font-mono); font-size: 8px; font-weight: 500;
        letter-spacing: .14em; text-transform: uppercase;
        padding: 4px 10px; border-radius: 2px;
    }
    .opp-badge.eligible   { background: var(--green-bg); color: var(--green); border: 1px solid var(--green-border); }
    .opp-badge.partial    { background: var(--amber-bg); color: var(--amber); border: 1px solid var(--amber-border); }
    .opp-badge.ineligible { background: var(--red-bg);   color: var(--red);   border: 1px solid var(--red-border); }

    /* ─── PRIORITY ACTION ────────────────────────────────────── */
    .priority-strip {
        background: var(--ink); border-radius: 3px;
        padding: 40px 48px; margin-bottom: 48px;
        position: relative; overflow: hidden;
        animation: fadeUp .6s var(--ease) .65s both;
        z-index: 1;
    }
    .priority-strip::before {
        content: ''; position: absolute;
        top: 0; left: 0; right: 0; height: 2px;
        background: linear-gradient(90deg, var(--gold), var(--teal-light), var(--gold));
        background-size: 200% 100%; animation: shimmer 3s linear infinite;
    }
    @keyframes shimmer {
        from { background-position: 200% center; }
        to   { background-position: -200% center; }
    }
    .priority-strip::after {
        content: 'PRIORITÉ';
        position: absolute; right: -10px; bottom: -20px;
        font-family: var(--font-display); font-size: 120px; font-weight: 300;
        color: rgba(255,255,255,.03); line-height: 1; pointer-events: none;
        letter-spacing: -.04em;
    }

    .priority-label {
        font-family: var(--font-mono); font-size: 9px;
        letter-spacing: .2em; text-transform: uppercase;
        color: rgba(253,252,250,.3); margin-bottom: 12px;
    }
    .priority-title {
        font-family: var(--font-display); font-size: 32px; font-weight: 300;
        color: var(--white); line-height: 1.2; margin-bottom: 16px;
    }
    .priority-title em { font-style: italic; color: var(--gold); }
    .priority-text {
        font-family: var(--font-ui); font-size: 14px; line-height: 1.7;
        color: rgba(253,252,250,.5); max-width: 640px; margin-bottom: 28px;
    }
    .priority-actions { display: flex; gap: 12px; }

    .btn-gold {
        display: inline-flex; align-items: center; gap: 10px;
        padding: 14px 28px; background: var(--gold); color: var(--ink);
        border: none; border-radius: 2px; cursor: pointer;
        font-family: var(--font-ui); font-size: 11px; font-weight: 700;
        letter-spacing: .12em; text-transform: uppercase; text-decoration: none;
        transition: transform .2s var(--ease), box-shadow .2s var(--ease), background .2s;
    }
    .btn-gold:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(200,169,110,.35);
        background: #d4b87a;
    }
    .btn-ghost {
        display: inline-flex; align-items: center; gap: 10px;
        padding: 14px 28px; background: transparent;
        color: rgba(253,252,250,.5); border: 1px solid rgba(255,255,255,.12);
        border-radius: 2px; cursor: pointer;
        font-family: var(--font-ui); font-size: 11px; font-weight: 700;
        letter-spacing: .12em; text-transform: uppercase; text-decoration: none;
        transition: color .2s, border-color .2s, transform .2s var(--ease);
    }
    .btn-ghost:hover { color: var(--white); border-color: rgba(255,255,255,.3); transform: translateY(-2px); }

    /* ─── TIMELINE ───────────────────────────────────────────── */
    .timeline-section {
        margin-bottom: 48px; position: relative; z-index: 1;
    }
    .timeline {
        display: grid; grid-template-columns: repeat(3, 1fr);
        gap: 2px; background: rgba(200,169,110,.12);
        border-radius: 3px; overflow: hidden;
    }
    .timeline-step {
        background: var(--white); padding: 32px 28px;
        position: relative; overflow: hidden;
        transition: background .2s;
        animation: fadeUp .6s var(--ease) both;
    }
    .timeline-step:nth-child(1) { animation-delay: .7s; }
    .timeline-step:nth-child(2) { animation-delay: .77s; }
    .timeline-step:nth-child(3) { animation-delay: .84s; }
    .timeline-step:hover { background: var(--surface); }

    .timeline-num {
        font-family: var(--font-display); font-size: 56px; font-weight: 300;
        color: rgba(200,169,110,.15); line-height: 1; margin-bottom: 12px;
        letter-spacing: -.03em;
    }
    .timeline-title {
        font-family: var(--font-display); font-size: 20px; font-weight: 400;
        color: var(--ink); margin-bottom: 8px;
    }
    .timeline-text {
        font-family: var(--font-ui); font-size: 12px; line-height: 1.7; color: var(--muted);
    }
    .timeline-period {
        display: inline-block; margin-top: 12px;
        font-family: var(--font-mono); font-size: 8px;
        letter-spacing: .14em; text-transform: uppercase;
        padding: 3px 10px; border-radius: 2px;
        background: rgba(200,169,110,.1); color: var(--gold);
    }

    /* ─── BOTTOM CTA ─────────────────────────────────────────── */
    .bottom-cta {
        display: flex; align-items: center; justify-content: space-between;
        padding: 32px 40px; background: var(--white);
        border: 1px solid rgba(200,169,110,.18); border-radius: 3px;
        animation: fadeUp .6s var(--ease) .85s both;
        position: relative; z-index: 1;
    }
    .bottom-cta-left { max-width: 520px; }
    .bottom-cta-title {
        font-family: var(--font-display); font-size: 24px; font-weight: 400;
        color: var(--ink); margin-bottom: 6px;
    }
    .bottom-cta-sub {
        font-family: var(--font-ui); font-size: 13px; color: var(--muted);
    }
    .bottom-cta-actions { display: flex; gap: 12px; flex-shrink: 0; }

    .btn-ink {
        display: inline-flex; align-items: center; gap: 10px;
        padding: 14px 24px; background: var(--ink); color: var(--white);
        border: none; border-radius: 2px; cursor: pointer;
        font-family: var(--font-ui); font-size: 11px; font-weight: 700;
        letter-spacing: .12em; text-transform: uppercase; text-decoration: none;
        transition: transform .2s var(--ease), box-shadow .2s, background .2s;
    }
    .btn-ink:hover {
        background: var(--teal); transform: translateY(-2px);
        box-shadow: 0 10px 28px rgba(15,76,92,.3);
    }
    .btn-outline {
        display: inline-flex; align-items: center; gap: 8px;
        padding: 14px 24px; background: transparent; color: var(--muted);
        border: 1.5px solid rgba(200,169,110,.25); border-radius: 2px;
        cursor: pointer; font-family: var(--font-ui); font-size: 11px; font-weight: 700;
        letter-spacing: .12em; text-transform: uppercase; text-decoration: none;
        transition: border-color .2s, color .2s, transform .2s;
    }
    .btn-outline:hover { color: var(--ink); border-color: var(--gold); transform: translateY(-2px); }

    /* ─── ANIMATIONS ─────────────────────────────────────────── */
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(18px); }
        to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:.4; } }

    /* ─── RESPONSIVE ─────────────────────────────────────────── */
    @media (max-width: 1024px) {
        .opp-grid { grid-template-columns: repeat(2, 1fr); }
        .timeline  { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
        .opp-page  { padding: 40px 20px 60px; }
        .opp-grid  { grid-template-columns: 1fr; }
        .verdict   { grid-template-columns: 1fr; }
        .bottom-cta { flex-direction: column; gap: 20px; }
    }
</style>

<div class="opp-page">

    <!-- ── TOP BAR ── -->
    <div class="opp-topbar">
        <div class="breadcrumb">
            <a href="/">Accueil</a>
            <span class="sep">/</span>
            <a href="/">Banque</a>
            <span class="sep">/</span>
            <a href="/banks">Situation</a>
            <span class="sep">/</span>
            <strong>Opportunités</strong>
        </div>

        <!-- Steps -->
        <div class="step-track">
            <div class="step-node">
                <div class="step-dot done">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5l2 2 4-4"/></svg>
                </div>
                <span>Banque</span>
            </div>
            <div class="step-connector"></div>
            <div class="step-node">
                <div class="step-dot done">
                    <svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 5l2 2 4-4"/></svg>
                </div>
                <span>Situation</span>
            </div>
            <div class="step-connector"></div>
            <div class="step-node">
                <div class="step-dot active">3</div>
                <span>Opportunités</span>
            </div>
        </div>
    </div>

    <!-- ── VERDICT ── -->
    {% set score = data.score | int %}
    {% if score >= 550 %}
        {% set verdict_class = "green" %}
    {% elif score >= 350 %}
        {% set verdict_class = "gold" %}
    {% elif score >= 150 %}
        {% set verdict_class = "orange" %}
    {% else %}
        {% set verdict_class = "red" %}
    {% endif %}

    <div class="verdict {{ verdict_class }}">
        <div>
            <div class="verdict-label">Étape 3 sur 3 · Résultats IA · {{ user.banque | upper if user.banque else 'Banque partenaire' }}</div>
            <div class="verdict-title">{{ data.profil_data.emoji }} {{ data.profil_data.nom }}</div>
            <div class="verdict-text">{{ data.profil_data.description }}</div>
        </div>
        <div class="verdict-score-box">
            <div class="verdict-score-label">Score IA</div>
            <div class="verdict-score-num" id="vScore">{{ data.score }}</div>
            <div class="verdict-score-denom">/ 1000</div>
            <div class="verdict-score-gauge">
                <div class="verdict-score-gauge-fill" id="vGaugeFill"></div>
            </div>
        </div>
    </div>

    <!-- ── OPPORTUNITIES ── -->
    <div class="section-head">
        <h2 class="section-head-title">Opportunités identifiées</h2>
        <div class="section-head-meta">
            {% if score >= 550 %}Accès complet · Profil qualifié
            {% elif score >= 350 %}Accès partiel · Conditions à améliorer
            {% else %}Accès limité · Stabilisation recommandée
            {% endif %}
        </div>
    </div>

    <div class="opp-grid">

        <!-- ── MAISON ── -->
        {% set house_eligible = score >= 550 %}
        {% set house_partial  = score >= 350 and not house_eligible %}
        <div class="opp-card {% if not house_eligible and not house_partial %}disabled{% endif %}">
            {% if house_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif house_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon house">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M3 13 L14 4 L25 13 L25 24 L3 24 Z"/>
                    <path d="M10 24 V17 H18 V24"/>
                </svg>
            </div>
            <div class="opp-category">Immobilier · Habitat</div>
            <div class="opp-name">Achat immobilier</div>
            <div class="opp-desc">Financement d'un logement principal via un crédit habitat adapté à votre capacité de remboursement.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">5M – 35M <small style="font-size:18px;">FDJ</small></div>
            </div>
            <div class="opp-amount-unit">Marché réel · F3 Balbala/PK12 dès 5M · Villa centre-ville jusqu'à 35M</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>F3 (80–120 m²) périphérie : 5 000 000 – 12 000 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>F4 (120–160 m²) Balbala/PK12 : 11 000 000 – 18 000 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.capacite_emprunt > 5000000 %}green{% else %}red{% endif %}"></div>
                        <span>Votre capacité d'emprunt estimée : {{ "{:,.0f}".format(data.capacite_emprunt) }} FDJ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── VOITURE ── -->
        {% set car_eligible = score >= 450 %}
        {% set car_partial  = score >= 280 and not car_eligible %}
        <div class="opp-card {% if not car_eligible and not car_partial %}disabled{% endif %}">
            {% if car_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif car_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon car">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 16 L7 9 H21 L24 16"/>
                    <rect x="2" y="16" width="24" height="7" rx="2"/>
                    <circle cx="8" cy="23" r="2"/>
                    <circle cx="20" cy="23" r="2"/>
                </svg>
            </div>
            <div class="opp-category">Transport · Mobilité</div>
            <div class="opp-name">Crédit automobile</div>
            <div class="opp-desc">Financement d'un véhicule neuf ou d'occasion pour vos besoins personnels ou professionnels.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">1,5M – 7,5M <small style="font-size:18px;">FDJ</small></div>
            </div>
            <div class="opp-amount-unit">Prix marché réel · occasion à neuf · Djibouti 2025</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Citadine / Corolla Cross quasi-neuve : ~3 700 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Toyota Prado TXL occasion : 2 700 000 – 3 000 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Toyota HardTop récent (2023) : ~7 500 000 FDJ</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── TERRAIN ── -->
        {% set land_eligible = score >= 500 %}
        {% set land_partial  = score >= 300 and not land_eligible %}
        <div class="opp-card {% if not land_eligible and not land_partial %}disabled{% endif %}">
            {% if land_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif land_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon land">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="3" y="5" width="22" height="18" rx="1"/>
                    <path d="M3 12 H25"/>
                    <path d="M12 5 V23"/>
                    <path d="M6 8 L9 8" stroke-linecap="round"/>
                    <path d="M6 15 L9 15" stroke-linecap="round"/>
                </svg>
            </div>
            <div class="opp-category">Foncier · Investissement</div>
            <div class="opp-name">Acquisition de terrain</div>
            <div class="opp-desc">Achat d'un terrain constructible à Djibouti. Investissement patrimonial à fort potentiel de valorisation.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">2M – 8M <small style="font-size:18px;">FDJ</small></div>
            </div>
            <div class="opp-amount-unit">Prix marché réel · selon zone · avec titre foncier</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Balbala / PK12 (80–120 m²) : 2 000 000 – 4 000 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Cité Nassib / Barwaqo (85–121 m²) : 2 100 000 – 3 600 000 FDJ</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot"></div>
                        <span>Zone Hodan / centre : 15 500 FDJ/m² · titre foncier requis</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── INVESTISSEMENT ── -->
        {% set inv_eligible = score >= 550 %}
        {% set inv_partial  = score >= 350 and not inv_eligible %}
        <div class="opp-card {% if not inv_eligible and not inv_partial %}disabled{% endif %}">
            {% if inv_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif inv_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon invest">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M4 20 L10 13 L15 16 L24 7"/>
                    <circle cx="24" cy="7" r="2" fill="currentColor"/>
                    <path d="M20 7 H24 V11"/>
                </svg>
            </div>
            <div class="opp-category">Finance · Placement</div>
            <div class="opp-name">Investissement à impact</div>
            <div class="opp-desc">Placement dans des fonds locaux alignés sur les ODD. Rendement estimé 6–12% par an selon le produit.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">6–12<small style="font-size:18px;"> % / an</small></div>
            </div>
            <div class="opp-amount-unit">Rendement estimé · fonds ODD certifiés</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if inv_eligible %}green{% elif inv_partial %}{% else %}red{% endif %}"></div>
                        <span>Score minimum : 550 / 1000</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.taux_epargne >= 10 %}green{% else %}red{% endif %}"></div>
                        <span>Taux d'épargne ≥ 10% (actuel : {{ data.taux_epargne }}%)</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.mois_securite >= 3 %}green{% else %}{% endif %}"></div>
                        <span>Coussin de sécurité constitué</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── MICROCRÉDIT PME ── -->
        {% set micro_eligible = score >= 350 %}
        {% set micro_partial  = score >= 150 and not micro_eligible %}
        <div class="opp-card {% if not micro_eligible and not micro_partial %}disabled{% endif %}">
            {% if micro_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif micro_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon micro">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="14" cy="14" r="10"/>
                    <path d="M14 8 V20 M10 11 H18 M10 17 H18"/>
                </svg>
            </div>
            <div class="opp-category">Crédit · Microcrédit</div>
            <div class="opp-name">Microcrédit productif</div>
            <div class="opp-desc">Petit prêt pour financer une activité génératrice de revenus, achat de matériel ou fonds de roulement.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">50K–500K <small style="font-size:18px;">DJF</small></div>
            </div>
            <div class="opp-amount-unit">Montant accessible · remboursement 6–24 mois</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if micro_eligible %}green{% elif micro_partial %}{% else %}red{% endif %}"></div>
                        <span>Score minimum : 350 / 1000</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.solde_net >= 0 %}green{% else %}red{% endif %}"></div>
                        <span>Solde mensuel ≥ 0 (actuel : {{ "{:+,.0f}".format(data.solde_net) }} DJF)</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot green"></div>
                        <span>Garant ou groupe de caution possible</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ── CRÉATION D'ENTREPRISE ── -->
        {% set biz_eligible = score >= 600 %}
        {% set biz_partial  = score >= 400 and not biz_eligible %}
        <div class="opp-card {% if not biz_eligible and not biz_partial %}disabled{% endif %}">
            {% if biz_eligible %}
                <span class="opp-badge eligible">Éligible</span>
            {% elif biz_partial %}
                <span class="opp-badge partial">Partiel</span>
            {% else %}
                <span class="opp-badge ineligible">Non éligible</span>
            {% endif %}

            <div class="opp-icon business">
                <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="1.5">
                    <rect x="4" y="12" width="20" height="12" rx="1"/>
                    <path d="M9 12 V8 C9 5.8 11 4 14 4 C17 4 19 5.8 19 8 V12"/>
                    <path d="M4 18 H24"/>
                    <circle cx="14" cy="18" r="2" fill="currentColor"/>
                </svg>
            </div>
            <div class="opp-category">Entrepreneuriat · PME</div>
            <div class="opp-name">Création d'entreprise</div>
            <div class="opp-desc">Financement de création ou expansion d'une PME locale avec accompagnement et accès aux marchés partenaires.</div>
            <div class="opp-divider"></div>
            <div class="opp-amount-row">
                <div class="opp-amount">{{ "{:,.0f}".format([data.capacite_emprunt * 0.6, 10000000] | min) }} <small style="font-size:18px;">DJF</small></div>
            </div>
            <div class="opp-amount-unit">Financement maximum estimé · plan d'affaires requis</div>
            <div style="margin-top: 16px;">
                <div class="opp-conditions">
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if biz_eligible %}green{% elif biz_partial %}{% else %}red{% endif %}"></div>
                        <span>Score minimum : 600 / 1000</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.taux_epargne >= 15 %}green{% else %}red{% endif %}"></div>
                        <span>Taux d'épargne ≥ 15% (actuel : {{ data.taux_epargne }}%)</span>
                    </div>
                    <div class="opp-condition">
                        <div class="opp-condition-dot {% if data.mois_securite >= 4 %}green{% else %}red{% endif %}"></div>
                        <span>Réserve ≥ 4 mois constituée</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ── PRIORITY ACTION STRIP ── -->
    <div class="priority-strip">
        <div class="priority-label">IA · Action recommandée</div>
        <div class="priority-title">
            {% if reco %}{{ reco.decision }}{% else %}Prochaine étape prioritaire{% endif %}
        </div>
        <div class="priority-text">
            {% if reco %}{{ reco.prochaine_etape }}{% else %}Consultez votre conseiller IMF pour accéder aux meilleures offres de votre banque partenaire.{% endif %}
        </div>
        <div class="priority-actions">
            <a href="/banks" class="btn-gold">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 7h10M7 2l5 5-5 5"/></svg>
                Affiner mon profil
            </a>
            <a href="/" class="btn-ghost">Accueil</a>
        </div>
    </div>

    <!-- ── TIMELINE / PLAN D'ACTION ── -->
    <div class="timeline-section">
        <div class="section-head">
            <h2 class="section-head-title">Plan d'action recommandé</h2>
            <div class="section-head-meta">Sur 12 mois</div>
        </div>

        <div class="timeline">
            <div class="timeline-step">
                <div class="timeline-num">01</div>
                <div class="timeline-title">Stabiliser</div>
                <div class="timeline-text">
                    {% if data.mois_securite < 3 %}
                        Constituez un coussin de sécurité de 3 mois ({{ "{:,.0f}".format(user.depenses * (3 - data.mois_securite)) }} DJF manquants). Épargnez automatiquement en début de mois.
                    {% else %}
                        Votre coussin de sécurité est solide ({{ data.mois_securite }} mois). Maintenez ce niveau et orientez l'excédent vers un compte rémunéré.
                    {% endif %}
                </div>
                <span class="timeline-period">Mois 1–3</span>
            </div>
            <div class="timeline-step">
                <div class="timeline-num">02</div>
                <div class="timeline-title">Optimiser</div>
                <div class="timeline-text">
                    {% if data.ratio_depenses > 55 %}
                        Réduisez votre ratio de charges de {{ data.ratio_depenses }}% à moins de 55%. Renégociez loyer, abonnements et charges fixes sur cette période.
                    {% else %}
                        Votre ratio de charges est sain. Augmentez votre taux d'épargne jusqu'à 20% pour accéder aux meilleures opportunités.
                    {% endif %}
                </div>
                <span class="timeline-period">Mois 4–7</span>
            </div>
            <div class="timeline-step">
                <div class="timeline-num">03</div>
                <div class="timeline-title">Investir</div>
                <div class="timeline-text">
                    {% if score >= 550 %}
                        Votre profil est qualifié. Consultez votre conseiller {{ user.banque | upper if user.banque else 'bancaire' }} pour finaliser un dossier de crédit adapté à votre projet prioritaire.
                    {% else %}
                        Une fois votre score > 550, vous accèderez au crédit habitat, terrain et investissement. Restez constant dans votre épargne mensuelle.
                    {% endif %}
                </div>
                <span class="timeline-period">Mois 8–12</span>
            </div>
        </div>
    </div>

    <!-- ── BOTTOM CTA ── -->
    <div class="bottom-cta">
        <div class="bottom-cta-left">
            <div class="bottom-cta-title">Affiner votre analyse</div>
            <div class="bottom-cta-sub">Mettez à jour vos données pour obtenir des opportunités recalculées en temps réel.</div>
        </div>
        <div class="bottom-cta-actions">
            <!-- Formulaire caché pour POST vers /forecast -->
            <form id="forecastForm" action="/forecast" method="POST" style="display:none;">
                <input type="hidden" name="banque"          value="{{ user.banque or '' }}">
                <input type="hidden" name="revenu"          value="{{ user.revenu }}">
                <input type="hidden" name="depenses"        value="{{ user.depenses }}">
                <input type="hidden" name="epargne"         value="{{ user.epargne }}">
                <input type="hidden" name="autres_revenus"  value="{{ user.autres_revenus }}">
                <input type="hidden" name="objectif_epargne" value="{{ user.objectif_epargne }}">
                <input type="hidden" name="horizon"         value="{{ user.horizon }}">
                <input type="hidden" name="situation"       value="{{ user.situation or '' }}">
                <input type="hidden" name="pays"            value="{{ user.pays or '' }}">
            </form>

            <button onclick="document.getElementById('forecastForm').submit()" class="btn-ink" style="cursor:pointer;">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 2 L7 7 L10 9 M7 2 C4 2 1 4.7 1 7.5 S4 13 7 13 S13 10.3 13 7.5"/></svg>
                GPS Financier · 3 ans
            </button>
            <a href="/" class="btn-outline">Accueil</a>
        </div>
    </div>

</div>

<script>
    // Animate score gauge
    window.addEventListener('DOMContentLoaded', () => {
        const score = {{ data.score | int }};
        const pct   = Math.min(score / 10, 100);
        setTimeout(() => {
            const el = document.getElementById('vGaugeFill');
            if (el) el.style.width = pct + '%';
        }, 400);
    });
</script>

{% endblock %}